// ====== CONFIG ======
const leagueOrderURL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=0&single=true&output=csv';

const sheetURLs = {
  NFL:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=1646106823&single=true&output=csv',
  NHL:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=905422182&single=true&output=csv',
  NBA:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=529321486&single=true&output=csv',
  MLB:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=355225860&single=true&output=csv',
  WNBA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=1033631487&single=true&output=csv'
};

// ====== ABBREVIATIONS ======
const TEAM_ABBR = {
  "Arizona Diamondbacks":"ARI","Atlanta Braves":"ATL","Baltimore Orioles":"BAL","Boston Red Sox":"BOS",
  "Chicago White Sox":"CHW","Chicago Cubs":"CHC","Cincinnati Reds":"CIN","Cleveland Guardians":"CLE",
  "Colorado Rockies":"COL","Detroit Tigers":"DET","Houston Astros":"HOU","Kansas City Royals":"KC",
  "Los Angeles Angels":"LAA","Los Angeles Dodgers":"LAD","Miami Marlins":"MIA","Milwaukee Brewers":"MIL",
  "Minnesota Twins":"MIN","New York Yankees":"NYY","New York Mets":"NYM","Athletics":"ATH",
  "Philadelphia Phillies":"PHI","Pittsburgh Pirates":"PIT","San Diego Padres":"SD","San Francisco Giants":"SF",
  "Seattle Mariners":"SEA","St. Louis Cardinals":"STL","Tampa Bay Rays":"TB","Texas Rangers":"TEX",
  "Toronto Blue Jays":"TOR","Washington Nationals":"WSH",

  "Atlanta Hawks":"ATL","Boston Celtics":"BOS","Brooklyn Nets":"BKN","Charlotte Hornets":"CHA",
  "Chicago Bulls":"CHI","Cleveland Cavaliers":"CLE","Dallas Mavericks":"DAL","Denver Nuggets":"DEN",
  "Detroit Pistons":"DET","Golden State Warriors":"GSW","Houston Rockets":"HOU","Indiana Pacers":"IND",
  "LA Clippers":"LAC","Los Angeles Lakers":"LAL","Memphis Grizzlies":"MEM","Miami Heat":"MIA",
  "Milwaukee Bucks":"MIL","Minnesota Timberwolves":"MIN","New Orleans Pelicans":"NOP","New York Knicks":"NYK",
  "Oklahoma City Thunder":"OKC","Orlando Magic":"ORL","Philadelphia 76ers":"PHI","Phoenix Suns":"PHX",
  "Portland Trail Blazers":"POR","Sacramento Kings":"SAC","San Antonio Spurs":"SAS","Toronto Raptors":"TOR",
  "Utah Jazz":"UTA","Washington Wizards":"WAS",

  "Atlanta Dream":"ATL","Chicago Sky":"CHI","Connecticut Sun":"CON","Dallas Wings":"DAL",
  "Indiana Fever":"IND","Las Vegas Aces":"LVA","Los Angeles Sparks":"LA","Minnesota Lynx":"MIN",
  "New York Liberty":"NY","Phoenix Mercury":"PHX","Seattle Storm":"SEA","Washington Mystics":"WAS",
  "Golden State Valkyries":"GSV",

  "Anaheim Ducks":"ANA","Arizona Coyotes":"ARI","Boston Bruins":"BOS","Buffalo Sabres":"BUF",
  "Calgary Flames":"CGY","Carolina Hurricanes":"CAR","Chicago Blackhawks":"CHI","Colorado Avalanche":"COL",
  "Columbus Blue Jackets":"CBJ","Dallas Stars":"DAL","Detroit Red Wings":"DET","Edmonton Oilers":"EDM",
  "Florida Panthers":"FLA","Los Angeles Kings":"LAK","Minnesota Wild":"MIN","Montreal Canadiens":"MTL",
  "Nashville Predators":"NSH","New Jersey Devils":"NJD","New York Islanders":"NYI","New York Rangers":"NYR",
  "Ottawa Senators":"OTT","Philadelphia Flyers":"PHI","Pittsburgh Penguins":"PIT","San Jose Sharks":"SJ",
  "Seattle Kraken":"SEA","St. Louis Blues":"STL","Tampa Bay Lightning":"TB","Toronto Maple Leafs":"TOR",
  "Vancouver Canucks":"VAN","Vegas Golden Knights":"VGK","Washington Capitals":"WSH","Winnipeg Jets":"WPG"
};

// ====== HELPERS ======
function parseTimeToLocal(timeStr) {
  const now = new Date();
  const dateString = now.toISOString().split('T')[0];
  return new Date(`${dateString} ${timeStr}`);
}

async function fetchAllGames() {
  const byLeague = {};
  await Promise.all(
    Object.entries(sheetURLs).map(async ([league, url]) => {
      try {
        const rows = (await (await fetch(url)).text())
          .trim().split(/\r?\n/).slice(1)
          .map(r => r.split(','));
        if (rows.length) byLeague[league] = rows;
      } catch (e) {
        console.warn(`failed ${league}`, e);
      }
    })
  );
  return byLeague;
}

async function loadLeagueOrder() {
  try {
    const txt = await (await fetch(leagueOrderURL)).text();
    return txt.trim().split(/\r?\n/).map(r => r.split(',')[0]).filter(l => sheetURLs[l]);
  } catch {
    return Object.keys(sheetURLs);
  }
}

function renderGamesByTab(byLeague, leagueOrder) {
  const containers = {
    scores: document.getElementById("tv-listings-scores"),
    today: document.getElementById("tv-listings-today"),
    live: document.getElementById("tv-listings-live")
  };

  Object.values(containers).forEach(c => (c.innerHTML = ""));

  const now = new Date();
  const todayDateStr = now.toLocaleDateString("en-CA");
  const yesterday = new Date(now);
  yesterday.setDate(now.getDate() - 1);
  const yesterdayStr = yesterday.toLocaleDateString("en-CA");

  leagueOrder.forEach(league => {
    const games = (byLeague[league] || []);
    const sections = { scores: [], today: [], live: [] };
    const seenTimes = new Set();

    games.forEach(cols => {
      const [, , matchup, statusRaw, score, startRaw] = cols;
      if (!matchup || !statusRaw) return;

      const [homeFull, awayFull] = matchup.split(" vs. ").map(t => t.trim());
      const home = TEAM_ABBR[homeFull] || homeFull;
      const away = TEAM_ABBR[awayFull] || awayFull;

      const status = statusRaw.toLowerCase();
      const dt = parseTimeToLocal(startRaw);
      const dateStr = dt.toLocaleDateString("en-CA");
      const timeStr = dt.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
      const showTime = !seenTimes.has(timeStr);
      seenTimes.add(timeStr);

      let displayTime;
      if (status.includes("final") || dateStr === yesterdayStr) {
        displayTime = "F";
      } else if (/in progress|half|inning/.test(status)) {
        displayTime = statusRaw;
      } else {
        displayTime = showTime ? timeStr : "";
      }

      const showScore = score && !/scheduled|not started/.test(status);
      const matchupDisplay = showScore ? `${home} ${score} ${away}` : `${home} vs. ${away}`;

      const row = document.createElement("div");
      row.className = "game-row";
      row.innerHTML = `
        <div class="game-time" style="color: ${/in progress|half|inning/.test(status) ? 'red' : '#ccc'}">${displayTime}</div>
        <div class="game-matchup">${matchupDisplay}</div>
        <div class="game-channel"></div>
      `;

      if (status.includes("final") || dateStr === yesterdayStr) {
        sections.scores.push(row);
      } else if (/in progress|half|inning/.test(status)) {
        sections.live.push(row);
      } else if (dateStr === todayDateStr) {
        sections.today.push(row);
      }
    });

    Object.entries(sections).forEach(([key, rows]) => {
      if (!rows.length) return;
      const leagueBox = document.createElement("div");
      leagueBox.className = "league-section";
      leagueBox.innerHTML = `<div style="margin-top:1em"></div><div class="league-header">${league}</div>`;
      rows.forEach(r => leagueBox.appendChild(r));
      containers[key].appendChild(leagueBox);
    });
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  const leagueOrder = await loadLeagueOrder();
  const data = await fetchAllGames();
  renderGamesByTab(data, leagueOrder);

  const tabs = document.querySelectorAll(".games-tab");
  const boxes = document.querySelectorAll(".games-content");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      boxes.forEach(b => b.style.display = "none");
      tab.classList.add("active");
      const target = tab.dataset.tab;
      document.getElementById("tv-listings-" + target).style.display = "block";
    });
  });

  document.querySelector(".games-tab[data-tab='today']")?.click();
});
