<script>
const leagueOrderURL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=0&single=true&output=csv';

const sheetURLs = {
  NFL:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=1646106823&single=true&output=csv',
  NHL:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=905422182&single=true&output=csv',
  NBA:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=529321486&single=true&output=csv',
  MLB:  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=355225860&single=true&output=csv',
  WNBA: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS75MzF61eZ1loPVTa56TvlfU2Z5ZXUiQuIL-nQ8XVlJYIzrHEzAoVstru5wwlEaTuZSlRd4XrwEXZM/pub?gid=1033631487&single=true&output=csv'
};

let leagueOrder = [];

async function loadLeagueOrder() {
  try {
    const txt = await (await fetch(leagueOrderURL)).text();
    leagueOrder = txt.trim().split(/\r?\n/).map(r => r.split(',')[0]).filter(l => sheetURLs[l]);
  } catch {
    leagueOrder = Object.keys(sheetURLs);
  }
}

function parseTimeToLocal(timeStr) {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const dateString = `${year}-${month}-${day}`;
  return new Date(`${dateString} ${timeStr}`);
}

async function fetchAllGames() {
  const byLeague = {};
  await Promise.all(
    Object.entries(sheetURLs).map(async ([league, url]) => {
      try {
        const rows = (await (await fetch(url)).text())
          .trim().split(/\r?\n/).slice(1)
          .map(r => r.split(','));
        if (rows.length) byLeague[league] = rows;
      } catch (e) {
        console.warn(`failed ${league}`, e);
      }
    })
  );
  return byLeague;
}

function renderGamesByTab(byLeague) {
  const containers = {
    scores: document.getElementById("tv-listings-scores"),
    today: document.getElementById("tv-listings-today"),
    live: document.getElementById("tv-listings-live")
  };

  Object.values(containers).forEach(c => (c.innerHTML = ""));

  const now = new Date();
  const todayDateStr = now.toLocaleDateString("en-CA");
  const yesterday = new Date(now);
  yesterday.setDate(now.getDate() - 1);
  const yesterdayStr = yesterday.toLocaleDateString("en-CA");

  leagueOrder.forEach(league => {
    const games = (byLeague[league] || []);
    const sections = { scores: [], today: [], live: [] };
    const seenTimes = new Set();

    games.forEach(cols => {
      const [, , matchup, statusRaw, score, startRaw] = cols;
      if (!matchup || !statusRaw) return;

      const [home, away] = matchup.split(" vs. ").map(t => t.trim());
      const status = statusRaw.toLowerCase();
      const dt = parseTimeToLocal(startRaw);
      const dateStr = dt.toLocaleDateString("en-CA");
      const timeStr = dt.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
      const showTime = !seenTimes.has(timeStr);
      seenTimes.add(timeStr);

      const row = document.createElement("div");
      row.className = "game-row";
      row.innerHTML = `
        <div class="game-time" style="color: ${/in progress|half|inning/.test(status) ? 'red' : '#ccc'}">${/in progress|half|inning/.test(status) ? statusRaw : (showTime ? timeStr : "")}</div>
        <div class="game-matchup">${score ? `${home} ${score} ${away}` : `${home} vs. ${away}`}</div>
        <div class="game-channel"></div>
      `;

      if (status.includes("final") || dateStr === yesterdayStr) {
        sections.scores.push(row);
      } else if (/in progress|half|inning/.test(status)) {
        sections.live.push(row);
      } else if (dateStr === todayDateStr) {
        sections.today.push(row);
      }
    });

    Object.entries(sections).forEach(([key, rows]) => {
      if (!rows.length) return;
      const leagueBox = document.createElement("div");
      leagueBox.className = "league-section";
      leagueBox.innerHTML = `<div style="margin-top:1em"></div><div class="league-header">${league}</div>`;
      rows.forEach(r => leagueBox.appendChild(r));
      containers[key].appendChild(leagueBox);
    });
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadLeagueOrder();
  const data = await fetchAllGames();
  renderGamesByTab(data);

  const tabs = document.querySelectorAll(".games-tab");
  const boxes = document.querySelectorAll(".games-content");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      boxes.forEach(b => b.style.display = "none");
      tab.classList.add("active");
      const target = tab.dataset.tab;
      document.getElementById("tv-listings-" + target).style.display = "block";
    });
  });

  // Activate default tab (today)
  document.querySelector(".games-tab[data-tab='today']")?.click();
});
</script>
